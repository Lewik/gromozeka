# Build Tree-sitter JNI native libraries for all platforms
# 
# Usage:
#   1. GitHub UI: Actions → "Build JNI Libraries" → Run workflow
#   2. CLI: gh workflow run build-jni-libraries.yml --ref main
#   3. Wait ~15 minutes for all platforms to build
#   4. Download: gh run download <run-id>
#   5. Copy to: infrastructure-ai/src/jvmMain/resources/lib/
#   6. Commit manually
#
# Platforms: Linux x64, macOS ARM64 (macOS x64 and Windows x64 disabled)

name: Build JNI Libraries

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  build:
    name: Build ${{ matrix.platform-key }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform-key: linux
            os: ubuntu-latest
            lib-path: lib/linux/x64
            lib-name: libktreesitter-kotlin.so
            
          - platform-key: macos-arm
            os: macos-latest
            lib-path: lib/macos/aarch64
            lib-name: libktreesitter-kotlin.dylib
            
          # macOS-13 runners are retired: https://github.com/actions/runner-images/issues/13046
          # - platform-key: macos-intel
          #   os: macos-13
          #   lib-path: lib/macos/x64
          #   lib-name: libktreesitter-kotlin.dylib
            
          # TODO: Fix CMake path escaping for Windows
          # - platform-key: windows
          #   os: windows-latest
          #   lib-path: lib/windows/x64
          #   lib-name: ktreesitter-kotlin.dll
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
      
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
      
      - name: Install build tools (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake gcc g++
      
      - name: Install build tools (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install cmake
      
      # TODO: Re-enable when Windows CMake path bug is fixed
      # - name: Install build tools (Windows)
      #   if: runner.os == 'Windows'
      #   run: |
      #     choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System'
      
      - name: Clone tree-sitter-kotlin grammar
        run: |
          mkdir -p infrastructure-ai/build
          git clone https://github.com/fwcd/tree-sitter-kotlin.git infrastructure-ai/build/tree-sitter-kotlin
        shell: bash
      
      - name: Generate grammar files
        run: ./gradlew :infrastructure-ai:tree-sitter-kotlin-grammar:generateGrammarFiles --no-configuration-cache
      
      - name: Create tree-sitter-kotlin header
        run: |
          mkdir -p infrastructure-ai/build/tree-sitter-kotlin/bindings/c
          cat > infrastructure-ai/build/tree-sitter-kotlin/bindings/c/tree-sitter-kotlin.h << 'EOF'
          #ifndef TREE_SITTER_KOTLIN_H_
          #define TREE_SITTER_KOTLIN_H_

          typedef struct TSLanguage TSLanguage;

          #ifdef __cplusplus
          extern "C" {
          #endif

          const TSLanguage *tree_sitter_kotlin(void);

          #ifdef __cplusplus
          }
          #endif

          #endif // TREE_SITTER_KOTLIN_H_
          EOF
        shell: bash
      
      - name: Build JNI library
        working-directory: infrastructure-ai/tree-sitter-kotlin-grammar/build/generated
        run: |
          cmake . -DCMAKE_BUILD_TYPE=Release
          cmake --build . --config Release
        shell: bash
      
      - name: Package library
        run: |
          mkdir -p target/${{ matrix.lib-path }}
          if [ -f infrastructure-ai/tree-sitter-kotlin-grammar/build/generated/${{ matrix.lib-name }} ]; then
            cp infrastructure-ai/tree-sitter-kotlin-grammar/build/generated/${{ matrix.lib-name }} target/${{ matrix.lib-path }}/
          elif [ -f infrastructure-ai/tree-sitter-kotlin-grammar/build/generated/Release/${{ matrix.lib-name }} ]; then
            cp infrastructure-ai/tree-sitter-kotlin-grammar/build/generated/Release/${{ matrix.lib-name }} target/${{ matrix.lib-path }}/
          else
            echo "ERROR: Library not found!"
            find infrastructure-ai/tree-sitter-kotlin-grammar/build/generated -name "${{ matrix.lib-name }}" || true
            exit 1
          fi
        shell: bash
      
      - name: Verify library
        run: |
          ls -lh target/${{ matrix.lib-path }}/${{ matrix.lib-name }}
          file target/${{ matrix.lib-path }}/${{ matrix.lib-name }} || true
        shell: bash
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: jni-${{ matrix.platform-key }}
          path: target/lib/**
          retention-days: 7
          if-no-files-found: error
