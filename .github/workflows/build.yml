name: Build Cross-Platform Packages

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

env:
  JAVA_VERSION: '21'
  GRADLE_VERSION: 'wrapper'

jobs:
  build:
    name: Build ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: macOS DMG
            os: macos-latest
            target-formats: Dmg
            artifact-pattern: '**/*.dmg'
            artifact-name: 'gromozeka-macos'
          - name: Linux AppImage
            os: ubuntu-latest
            target-formats: AppImage
            artifact-pattern: '**/*.AppImage'
            artifact-name: 'gromozeka-linux'
          - name: Cross-Platform JAR
            os: ubuntu-latest
            target-formats: Jar
            artifact-pattern: '**/*.jar'
            artifact-name: 'gromozeka-jar'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v3
        with:
          gradle-version: ${{ env.GRADLE_VERSION }}

      - name: Extract version from tag or input
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Building version: $VERSION"

      - name: Update package version in build.gradle.kts
        shell: bash
        run: |
          # Update macOS package version
          echo "Using version $VERSION for macOS"
          
          # Update build.gradle.kts with unified version
          sed -i.bak 's/packageVersion = ".*"/packageVersion = "'$VERSION'"/g' bot/build.gradle.kts
          sed -i.bak 's/packageBuildVersion = ".*"/packageBuildVersion = "'$VERSION'"/g' bot/build.gradle.kts
          sed -i.bak 's/dmgPackageVersion = ".*"/dmgPackageVersion = "'$VERSION'"/g' bot/build.gradle.kts

      - name: Install FUSE for AppImage
        if: matrix.target-formats == 'AppImage'
        shell: bash
        run: |
          echo "Installing FUSE library for AppImage support..."
          sudo apt-get update
          # Try libfuse2t64 first (Ubuntu 24.04+), fallback to libfuse2 (Ubuntu 22.04)
          sudo apt-get install -y libfuse2t64 || sudo apt-get install -y libfuse2
          echo "FUSE installation completed"

      - name: Build native distributions
        shell: bash
        env:
          TARGET_FORMATS: ${{ matrix.target-formats }}
        run: |
          if [ "${{ matrix.target-formats }}" = "AppImage" ]; then
            echo "Building AppImage for Linux..."
            chmod +x build-appimage.sh
            ./build-appimage.sh
          elif [ "${{ matrix.target-formats }}" = "Jar" ]; then
            echo "Building cross-platform JAR..."
            ./gradlew :bot:removeJarSignatures
          elif [ "$RUNNER_OS" = "Windows" ]; then
            ./gradlew.bat :bot:packageDistributionForCurrentOS
          else
            ./gradlew :bot:packageDistributionForCurrentOS
          fi

      - name: Find and list built packages
        shell: bash
        run: |
          echo "Built packages:"
          if [ "${{ matrix.target-formats }}" = "AppImage" ]; then
            find build/appimage -type f -name "Gromozeka-*.AppImage" -exec ls -la {} \; 2>/dev/null || echo "No AppImage files found"
          elif [ "${{ matrix.target-formats }}" = "Jar" ]; then
            find bot/build/compose/jars -type f -name "*.jar" -exec ls -la {} \; 2>/dev/null || echo "No JAR files found"
          else
            find bot/build/compose/binaries -type f -name "*.dmg" -exec ls -la {} \; 2>/dev/null || echo "No DMG files found"
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}-${{ env.VERSION }}
          path: |
            ${{ matrix.target-formats == 'AppImage' && 'build/appimage/Gromozeka-*.AppImage' || matrix.target-formats == 'Jar' && 'bot/build/compose/jars/*.jar' || 'bot/build/compose/binaries/**/*.dmg' }}
          retention-days: 30

  release:
    name: Create GitHub Release
    needs: [build]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          find artifacts -type f -name "*.dmg" -exec cp {} release-assets/ \;
          find artifacts -type f -name "Gromozeka-*.AppImage" -exec cp {} release-assets/ \;
          find artifacts -type f -name "*.jar" -exec cp {} release-assets/ \;
          ls -la release-assets/

      - name: Generate release notes
        run: |
          cat > release-notes.md << 'EOF'
          # Gromozeka v${{ env.VERSION }}

          ## Downloads

          ### macOS
          - **Universal Binary (M1/M2/M3/M4 + Intel)**: `Gromozeka-${{ env.VERSION }}.dmg`

          ### Linux
          - **AppImage (x86_64)**: `Gromozeka-${{ env.VERSION }}-x86_64.AppImage`

          ### Cross-Platform (Java)
          - **JAR file**: `gromozeka-jvm-${{ env.VERSION }}.jar`

          ## Installation

          ### macOS
          1. Download the `.dmg` file
          2. Open it and drag Gromozeka to Applications folder
          3. First launch: Right-click â†’ Open (to bypass Gatekeeper)
          4. Grant accessibility permissions when prompted for global hotkey support

          ### Linux
          1. Download the `.AppImage` file
          2. Make it executable: `chmod +x Gromozeka-${{ env.VERSION }}-x86_64.AppImage`
          3. Run it: `./Gromozeka-${{ env.VERSION }}-x86_64.AppImage`
          4. **Requirements**: Claude Code CLI must be installed and available in PATH
          5. **Compatibility**: Works on Ubuntu 14.04+, Fedora, openSUSE, Arch, and other distributions (glibc 2.17+)

          ### Cross-Platform JAR
          1. **Requirements**: Java 21+ installed on your system
          2. Download the `.jar` file
          3. Run it: `java -jar gromozeka-jvm-${{ env.VERSION }}.jar`
          4. **Claude Code CLI**: Must be installed and available in PATH
          5. **Works on**: Any platform with Java 21+ (Windows, macOS, Linux, etc.)

          ## What's New

          - Multi-armed AI agent with Claude Code CLI integration
          - Advanced Push-to-Talk (PTT) system with global hotkeys
          - Real-time streaming interface
          - Session management and history
          - Native library bundling for improved macOS compatibility

          ---
          ðŸ¤– Generated with [Claude Code](https://claude.ai/code)
          EOF

      - name: Determine release type
        run: |
          # Extract patch version (last number in X.Y.Z)
          PATCH_VERSION=$(echo "${{ env.VERSION }}" | cut -d'.' -f3)
          echo "Patch version: $PATCH_VERSION"

          # If patch != 0, it's a pre-release
          if [ "$PATCH_VERSION" != "0" ]; then
            echo "IS_PRERELEASE=true" >> $GITHUB_ENV
            echo "This is a pre-release version (patch != 0)"
          else
            echo "IS_PRERELEASE=false" >> $GITHUB_ENV
            echo "This is a stable release version (patch == 0)"
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event_name == 'workflow_dispatch' && format('v{0}', env.VERSION) || github.ref_name }}
          name: Gromozeka v${{ env.VERSION }}
          body_path: release-notes.md
          files: release-assets/*
          draft: false
          prerelease: ${{ env.IS_PRERELEASE == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}